<ng-container *ngIf="isProgressSpinnerActive">
  <div class="spinner-wrapper">
    <mat-progress-spinner color="accent" mode="determinate" [value]="progressSpinnerValue">
    </mat-progress-spinner>
  </div>
</ng-container>
<mat-accordion>
  <mat-expansion-panel [expanded]="accordionStep === 'input'" (opened)="open('input')">
    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon>input</mat-icon>
        Decklist
      </mat-panel-title>
    </mat-expansion-panel-header>
    <mat-form-field>
      <textarea matInput [(ngModel)]="decklist" placeholder="Decklist (Simple Format)" rows="10"></textarea>
    </mat-form-field>
    <mat-action-row>
      <button mat-raised-button color="accent" (click)="submitDecklist(true)">
        <mat-icon>save_alt</mat-icon>
        Submit
      </button>
    </mat-action-row>
  </mat-expansion-panel>
  <mat-expansion-panel [expanded]="accordionStep === 'groups'" (opened)="open('groups')">
    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon>label</mat-icon>
        Deck Results
      </mat-panel-title>
      <ng-container *ngIf="cardCounts.total > 0">
        <mat-panel-description>
          {{cardCounts.total}} total, {{cardCounts.unique}} unique
        </mat-panel-description>
      </ng-container>
    </mat-expansion-panel-header>
    <div align="end">
      <mat-form-field style="max-width: 300px;">
        <mat-label>Group By</mat-label>
        <mat-select [(ngModel)]="groupByMode" (selectionChange)="selectedMode($event)">
          <mat-option *ngFor="let mode of groupByModes" [value]="mode">
            {{mode}}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <button mat-icon-button color="accent" (click)="refreshGroups()">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
    <ng-container *ngIf="cardCounts.missing > 0">
      <p>There were {{cardCounts.missing}} missing cards; please check log for details.</p>
    </ng-container>
    <ng-container *ngIf="!isDecklistReady || cardsGrouped.length === 0">
      <ng-container *ngTemplateOutlet="noDataWarning;"></ng-container>
    </ng-container>
    <ng-container *ngIf="isDecklistReady && cardsGrouped.length > 0">
      <mat-accordion multi="true">
        <mat-expansion-panel *ngFor="let group of cardsGrouped; first as isFirst;" [expanded]="isFirst">
          <mat-expansion-panel-header>
            <mat-panel-title>
              {{group[0] | uppercase}} ({{group[2]}})
            </mat-panel-title>
          </mat-expansion-panel-header>
          <table mat-table [dataSource]="group[1]">
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef class="name-col">Name</th>
              <td mat-cell *matCellDef="let element">
                {{element.name}}
                <button mat-icon-button color="accent" (click)="openDialogCardDetails(element)">
                  <mat-icon>zoom_in</mat-icon>
                </button>
              </td>
            </ng-container>
            <ng-container matColumnDef="count">
              <th mat-header-cell *matHeaderCellDef class="count-col">#</th>
              <td mat-cell *matCellDef="let element">{{element.count}}</td>
            </ng-container>
            <ng-container matColumnDef="tags">
              <th mat-header-cell *matHeaderCellDef class="tags-col">Tags</th>
              <td mat-cell *matCellDef="let element">
                <mat-chip-list>
                  <button mat-mini-fab (click)="openDialogAddTag(element)">
                    <mat-icon>add</mat-icon>
                  </button>
                  <ng-container *ngIf="element.CardTagLinks">
                    <ng-container *ngFor="let link of element.CardTagLinks">
                      <mat-chip *ngIf="link && link.TagName" color="warn" selected (removed)="removeCardTagLink(link)">
                        {{link.TagName}}
                        <mat-icon matChipRemove>cancel</mat-icon>
                      </mat-chip>
                    </ng-container>
                  </ng-container>
                </mat-chip-list>
              </td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="['count', 'name', 'tags']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['count', 'name', 'tags'];"></tr>
          </table>
        </mat-expansion-panel>
      </mat-accordion>
    </ng-container>
    <mat-action-row>
      <button mat-raised-button color="accent" (click)="refreshGroups()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </mat-action-row>
  </mat-expansion-panel>
  <mat-expansion-panel [expanded]="accordionStep === 'charts'" (opened)="open('charts')">
    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon>insert_chart_outlined</mat-icon>
        Charts
      </mat-panel-title>
    </mat-expansion-panel-header>
    <mat-grid-list [cols]="chartsColumns" rowHeight="3:2" id="charts-grid">
      <mat-grid-tile *ngIf="!(isChartCMCCurve || isChartColorPie || isChartTagsRadar)" [colspan]="chartsColumns">
        <ng-container *ngTemplateOutlet="noDataWarning;"></ng-container>
      </mat-grid-tile>
      <mat-grid-tile *ngIf="isChartCMCCurve">
        <app-chart-cmc [model]="chartCMCCurve"></app-chart-cmc>
      </mat-grid-tile>
      <mat-grid-tile *ngIf="isChartColorPie">
        <app-chart-color-pie [model]="chartColorPie"></app-chart-color-pie>
      </mat-grid-tile>
      <mat-grid-tile *ngIf="isChartTagsRadar">
        <app-chart-tags [model]="chartTagsRadar"></app-chart-tags>
      </mat-grid-tile>
    </mat-grid-list>
  </mat-expansion-panel>
  <mat-expansion-panel [expanded]="accordionStep === 'messages'" (opened)="open('messages')">
    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon>insert_comment</mat-icon>
        Log Messages
      </mat-panel-title>
    </mat-expansion-panel-header>
    <app-messages></app-messages>
  </mat-expansion-panel>
</mat-accordion>
<ng-template #noDataWarning>
  <p>No data, please submit a decklist first.</p>
</ng-template>
